{% extends 'base.html' %}

{% block title %}
  Publicaciones
{% endblock title %}

{% block content %}

  <!-- Filtrar mensajes con la etiqueta 'publicacion' -->
  {% if messages %}
    {% for message in messages %}
      {% if 'publicacion' in message.tags %}
        <div class="alert {% if 'success' in message.tags %}alert-success{% elif 'error' in message.tags %}alert-danger{% else %}alert-info{% endif %}">
          {{ message }}
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}

  <h1>Lista de Publicaciones</h1>
  <table class="table">
    <thead>
      <tr>
        <th>Tipo</th>
        <th>Título</th>
        <th>Fecha de Creación</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for publicacion in publicaciones %}
      <tr>
        <td>{{ publicacion.tipo|capfirst }}</td>
        <td>{{ publicacion.titulo }}</td>
        <td>{{ publicacion.fecha_creacion }}</td>
        <td>
          <button type="button" class="btn btn-success" data-toggle="modal" data-target="#verPublicacionModal{{ publicacion.id }}">Ver</button>
          <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#eliminarPublicacionModal{{ publicacion.id }}">Eliminar</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#crearPublicacionModal">
    Crear Publicación
  </button>

  <!-- Modal para crear una nueva publicación -->
  <div class="modal fade" id="crearPublicacionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Crear Nueva Publicación</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                {{ form.tipo.label_tag }}
                {{ form.tipo }}
            </div>
            <div class="form-group">
                {{ form.titulo.label_tag }}
                {{ form.titulo }}
                <small class="form-text text-muted">Título: Máximo 60 caracteres.</small>
                <small id="tituloCounter" class="form-text text-muted">0 / 60</small>
            </div>
            <div class="form-group">
                {{ form.detalle.label_tag }}
                {{ form.detalle }}
                <small class="form-text text-muted">Detalle: Máximo 350 caracteres.</small>
                <small id="detalleCounter" class="form-text text-muted">0 / 350</small>
            </div>
            <div class="form-group">
                {{ form.imagen.label_tag }}
                {{ form.imagen }}
            </div>
            <button type="submit" class="btn btn-primary">Crear</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para ver detalles de la publicación -->
  {% for publicacion in publicaciones %}
  <div class="modal fade" id="verPublicacionModal{{ publicacion.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">{{ publicacion.tipo|capfirst }}</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p><strong>Título:</strong> {{ publicacion.titulo }}</p>
          <p><strong>Detalle:</strong> {{ publicacion.detalle }}</p>
          {% if publicacion.imagen %}
            <img src="{{ publicacion.imagen.url }}" alt="Imagen de la publicación" style="max-width: 100%;">
          {% else %}
            <p><em>No hay imagen disponible para esta publicación.</em></p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <!-- Modal para eliminar publicación -->
  {% for publicacion in publicaciones %}
  <div class="modal fade" id="eliminarPublicacionModal{{ publicacion.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Eliminar Publicación</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p>¿Estás seguro de que deseas eliminar esta publicación?</p>
        </div>
        <div class="modal-footer">
          <form method="post" action="{% url 'eliminar_publicacion' publicacion.id %}">
            {% csrf_token %}
            <input type="hidden" name="delete_publicacion" value="{{ publicacion.id }}">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-danger">Eliminar</button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <script>
    document.addEventListener("DOMContentLoaded", function() {
      var tituloInput = document.querySelector('input[name="titulo"]');
      var detalleInput = document.querySelector('textarea[name="detalle"]');
      var tituloCounter = document.getElementById("tituloCounter");
      var detalleCounter = document.getElementById("detalleCounter");

      tituloInput.addEventListener("input", function() {
        var length = tituloInput.value.length;
        if (length > 60) {
          tituloInput.value = tituloInput.value.substring(0, 60);
        }
        tituloCounter.textContent = tituloInput.value.length + " / 60";
      });

      detalleInput.addEventListener("input", function() {
        var length = detalleInput.value.length;
        if (length > 350) {
          detalleInput.value = detalleInput.value.substring(0, 350);
        }
        detalleCounter.textContent = detalleInput.value.length + " / 350";
      });
    });
  </script>

{% endblock content %}
